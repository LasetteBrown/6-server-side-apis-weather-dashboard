<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link href="./assets/css/style.css" rel="stylesheet">
    <title>Weather Dashboard</title>
</head>

<body>
    <header class="nav justify-content-center">
        <div class="nav-item">
            <h1>Weather Dashboard</h1>
        </div>
    </header>
    <main class="row">
        <aside class="col-md-4">
            <h5>Search for a City:</h5>
            <form class="d-flex" id="city-search">
                <input class="form-control me-2" type="search" name="city" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-secondary" id="city-search-btn" type="submit"
                    value="submit">Search</button>
            </form>
            <div class="past-searches">

            </div>
        </aside>
        <div class="col-md-8">
            <div class="card">
                <div class="card-body current-weather">
                    <h3 class="card-title city-name">Check the weather for any city!</h3>
                    <div class="city-weather"></div>
                </div>
            </div>
            <div class="5day-forcast">
            </div>
        </div>

    </main>
    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>

    <!-- Added link to the jQuery library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Added link to my javascript -->
    <script src="./Assets/js/luxon.js"></script>
    <script>
        //when the user clicks on the search button
        var searchInput = ""
        var now = luxon.DateTime.local()

        var searchHistory = []

        searchHistory = JSON.parse(localStorage.getItem("events"));
        //unless there is nothing saved...
        if (searchHistory === null) {
            searchHistory = []
        }

        function showPrevious() {
            $(".past-searches").html("")

            for (var i = 0; i < searchHistory.length; i++) {

                var previousSearch = $("<div>")
                previousSearch.text(searchHistory[i])
                $(".past-searches").append(previousSearch)

            }

        }

        function storeSearches() {
            searchHistory.push(searchInput)
            window.localStorage.setItem("previous", JSON.stringify(searchHistory));
        }

        function getWeather() {

            $(".city-weather").html("")

            var requestUrl = 'https://api.openweathermap.org/data/2.5/weather?q=' + searchInput + '&units=imperial&appid=7aae0d65ca472bf0f42c97f44d7c7a82';
            fetch(requestUrl)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {

                    var locationLat = data.coord.lat
                    var locationLon = data.coord.lon
                    var locationTime = data.coord.dt

                    var iconTag = data.weather[0].icon
                    var iconImage = $("<img>")
                    iconImage.attr("src", `http://openweathermap.org/img/wn/${iconTag}@2x.png`)

                    $(".city-name").text(data.name + " (" + now.toLocaleString({ year: 'numeric', month: 'numeric', day: 'numeric', }) + ") ")
                    $(".city-name").append(iconImage)

                    var temperature = $("<div>")
                    temperature.text("Temperature: " + data.main.temp + " °F")
                    temperature.attr("units", "imperial")
                    $(".city-weather").append(temperature)

                    var humidity = $("<div>")
                    humidity.text("Humidity: " + data.main.humidity + " %")
                    $(".city-weather").append(humidity)

                    var windSpeed = $("<div>")
                    windSpeed.text("Wind Speed: " + data.wind.speed + " MPH")
                    $(".city-weather").append(windSpeed)

                    $("div").attr("style", "padding:10px")
                    getUvIndex(locationLat, locationLon, locationTime)
                    get5Day()
                });

        }

        function getUvIndex(locationLat, locationLon, locationTime) {
            var uvUrl = `http://api.openweathermap.org/data/2.5/uvi?lat=${locationLat}&lon=${locationLon}&date_iso=${locationTime}&appid=7aae0d65ca472bf0f42c97f44d7c7a82`
            console.log("lon: ", locationLon, "lat: ", locationLat)
            fetch(uvUrl)
                .then(function (response) {
                    return response.json();
                })
                .then(function (uvData) {

                    var uvIndex = $("<div>")
                    uvIndex.addClass("uv-risk")
                    uvIndex.text("UV Index: " + uvData.value)
                    $(".city-weather").append(uvIndex)

                    var uvRisk = parseInt(uvData.value)
                    if (uvRisk <= 2) {
                        $(".uv-risk").attr("style", "background-color:green")
                    } else if (uvRisk <= 5) {
                        $(".uv-risk").attr("style", "background-color:yellow; color:gray")

                    } else if (uvRisk <= 7) {
                        $(".uv-risk").attr("style", "background-color:orange")

                    } else {
                        $(".uv-risk").attr("style", "background-color:red")
                    }
                })
        }

        function get5Day() {
            $(".5day-forcast").html("")

            var forcastUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${searchInput}&units=imperial&appid=7aae0d65ca472bf0f42c97f44d7c7a82`
            fetch(forcastUrl)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    console.log(data)

                    for (var i = 0; i < 5; i++) {
                        var day = $("<div>")
                        day.addClass("forcast-card")
                        $(".5day-forcast").append(day)

                        var forcastDate = $("<h5>")
                        forcastDate.text(now.plus({ days: 1 + i }).toLocaleString({ year: 'numeric', month: 'numeric', day: 'numeric', }))
                        day.append(forcastDate)

                        var iconId = data.list[i].weather[0].icon
                        var forcastIcon = $("<img>")
                        forcastIcon.attr("src", `http://openweathermap.org/img/wn/${iconId}@2x.png`)
                        day.append(forcastIcon)

                        var forcastTemp = $("<p>")
                        forcastTemp.text("Temp: " + data.list[i].main.temp + " °F")
                        day.append(forcastTemp)

                        var forcastHumid = $("<p>")
                        forcastHumid.text("Humidity: " + data.list[i].main.humidity + " %")
                        day.append(forcastHumid)

                    }
                })
        }

        $("#city-search-btn").on("click", function () {
            event.preventDefault();

            searchInput = document.getElementById("city-search").elements["city"].value.trim()
            storeSearches()
            showPrevious()
            getWeather()
        })

        $(".past-searches").on("click", function () {

            searchInput = event.target.innerText
            getWeather()
        })

        showPrevious()


//take the user's search input
//and fetch matching information from the weather api
//display the name of the city
//display today's date
//display an icon matching the current weather
//display the current temperature
//display the current humidity
//display the current windspeed
//display the current UV index
//with a background color appropriate to it's rating
//display the 5 day forcast
//with a box for each day
//in which is displayed the date, weather icon, temp, and humitidy
//save the search input to local storage
//and display past searches below the search bar
//when any past city is clicked
//the data for that city is displayed again

    </script>
</body>

</html>